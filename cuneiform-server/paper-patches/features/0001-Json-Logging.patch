From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Lexie Malina <alex@t-ch.net>
Date: Mon, 13 Jan 2025 08:34:42 -0600
Subject: [PATCH] Json Logging for Promtail ingestion


diff --git a/src/main/resources/jsonlogging.json b/src/main/resources/jsonlogging.json
new file mode 100644
index 0000000000000000000000000000000000000000..972c2199cf9851568ed618062a3c3a5b93ccc3c0
--- /dev/null
+++ b/src/main/resources/jsonlogging.json
@@ -0,0 +1,64 @@
+{
+  "instant": {
+    "$resolver": "timestamp",
+    "pattern": {
+      "format": "yyyy-MM-dd'T'HH:mm:ss.SSS'Z'",
+      "timeZone": "UTC"
+    }
+  },
+  "level": {
+    "$resolver": "level",
+    "field": "name"
+  },
+  "logger": {
+    "$resolver": "logger",
+    "field": "name"
+  },
+  "thread": {
+    "name": {
+      "$resolver": "thread",
+      "field": "name"
+    },
+    "id": {
+      "$resolver": "thread",
+      "field": "id"
+    }
+  },
+  "message": {
+    "$resolver": "message"
+  },
+  "exception": {
+    "className": {
+      "$resolver": "exception",
+      "field": "className"
+    },
+    "message": {
+      "$resolver": "exception",
+      "field": "message"
+    },
+    "stackTrace": {
+      "$resolver": "exception",
+      "field": "stackTrace",
+      "stackTrace": {
+        "elementTemplate": {
+          "class": {
+            "$resolver": "stackTraceElement",
+            "field": "className"
+          },
+          "method": {
+            "$resolver": "stackTraceElement",
+            "field": "methodName"
+          },
+          "file": {
+            "$resolver": "stackTraceElement",
+            "field": "fileName"
+          },
+          "line": {
+            "$resolver": "stackTraceElement",
+            "field": "lineNumber"
+          }
+        }
+      }
+    }
+  }
+}
diff --git a/src/main/resources/log4j2.xml b/src/main/resources/log4j2.xml
index d2a75850af9c6ad2aca66a5f994f1b587d73eac4..2dab9bee278a3cd4e9f384e1b17ef5417091dd86 100644
--- a/src/main/resources/log4j2.xml
+++ b/src/main/resources/log4j2.xml
@@ -1,54 +1,50 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <Configuration status="WARN" shutdownHook="disable">
-    <Appenders>
-        <Queue name="ServerGuiConsole">
-            <PatternLayout pattern="[%d{HH:mm:ss} %level]: %msg{nolookups}%n" />
-        </Queue>
-        <TerminalConsole name="TerminalConsole">
-            <PatternLayout>
-                <LoggerNamePatternSelector defaultPattern="%highlightError{[%d{HH:mm:ss} %level]: [%logger] %msg%n%xEx{full}}">
-                    <!-- Log root, Minecraft, Mojang and Bukkit loggers without prefix -->
-                    <!-- Disable prefix for various plugins that bypass the plugin logger -->
-                    <PatternMatch key=",net.minecraft.,Minecraft,com.mojang.,com.sk89q.,ru.tehkode.,Minecraft.AWE"
-                                  pattern="%highlightError{[%d{HH:mm:ss} %level]: %msg%n%xEx{full}}" />
-                </LoggerNamePatternSelector>
-            </PatternLayout>
-        </TerminalConsole>
-        <RollingRandomAccessFile name="File" fileName="logs/latest.log" filePattern="logs/%d{yyyy-MM-dd}-%i.log.gz">
-            <PatternLayout>
-                <LoggerNamePatternSelector defaultPattern="[%d{HH:mm:ss}] [%t/%level]: [%logger] %stripAnsi{%msg}%n%xEx{full}">
-                    <!-- Log root, Minecraft, Mojang and Bukkit loggers without prefix -->
-                    <!-- Disable prefix for various plugins that bypass the plugin logger -->
-                    <PatternMatch key=",net.minecraft.,Minecraft,com.mojang.,com.sk89q.,ru.tehkode.,Minecraft.AWE"
-                                  pattern="[%d{HH:mm:ss}] [%t/%level]: %stripAnsi{%msg}%n%xEx{full}" />
-                </LoggerNamePatternSelector>
-            </PatternLayout>
-            <Policies>
-                <TimeBasedTriggeringPolicy />
-                <OnStartupTriggeringPolicy />
-            </Policies>
-            <DefaultRolloverStrategy max="1000"/>
-        </RollingRandomAccessFile>
-        <Async name="Async">
-            <AppenderRef ref="rewrite"/>
-        </Async>
-        <Rewrite name="rewrite">
-            <StacktraceDeobfuscatingRewritePolicy />
-            <AppenderRef ref="rewrite2"/>
-        </Rewrite>
-        <Rewrite name="rewrite2">
-            <ExtraClassInfoRewritePolicy />
-            <AppenderRef ref="File"/>
-            <AppenderRef ref="TerminalConsole" level="info"/>
-            <AppenderRef ref="ServerGuiConsole" level="info"/>
-        </Rewrite>
-    </Appenders>
-    <Loggers>
-        <Root level="info">
-            <filters>
-                <MarkerFilter marker="NETWORK_PACKETS" onMatch="DENY" onMismatch="NEUTRAL" />
-            </filters>
-            <AppenderRef ref="Async"/>
-        </Root>
-    </Loggers>
+  <Appenders>
+    <Queue name="ServerGuiConsole">
+      <PatternLayout pattern="[%d{HH:mm:ss} %level]: %msg{nolookups}%n"/>
+    </Queue>
+    <TerminalConsole name="TerminalConsole">
+      <PatternLayout>
+        <LoggerNamePatternSelector
+          defaultPattern="%highlightError{[%d{HH:mm:ss} %level]: [%logger] %msg%n%xEx{full}}">
+          <!-- Log root, Minecraft, Mojang and Bukkit loggers without prefix -->
+          <!-- Disable prefix for various plugins that bypass the plugin logger -->
+          <PatternMatch
+            key=",net.minecraft.,Minecraft,com.mojang.,com.sk89q.,ru.tehkode.,Minecraft.AWE"
+            pattern="%highlightError{[%d{HH:mm:ss} %level]: %msg%n%xEx{full}}"/>
+        </LoggerNamePatternSelector>
+      </PatternLayout>
+    </TerminalConsole>
+    <RollingRandomAccessFile name="File" fileName="logs/latest.json"
+      filePattern="logs/%d{yyyy-MM-dd}-%i.json.gz">
+      <JsonTemplateLayout eventTemplateUri="classpath:jsonlogging.json"/>
+      <Policies>
+        <TimeBasedTriggeringPolicy/>
+        <OnStartupTriggeringPolicy/>
+      </Policies>
+      <DefaultRolloverStrategy max="1000"/>
+    </RollingRandomAccessFile>
+    <Async name="Async">
+      <AppenderRef ref="rewrite"/>
+    </Async>
+    <Rewrite name="rewrite">
+      <StacktraceDeobfuscatingRewritePolicy/>
+      <AppenderRef ref="rewrite2"/>
+    </Rewrite>
+    <Rewrite name="rewrite2">
+      <ExtraClassInfoRewritePolicy/>
+      <AppenderRef ref="File"/>
+      <AppenderRef ref="TerminalConsole" level="info"/>
+      <AppenderRef ref="ServerGuiConsole" level="info"/>
+    </Rewrite>
+  </Appenders>
+  <Loggers>
+    <Root level="info">
+      <filters>
+        <MarkerFilter marker="NETWORK_PACKETS" onMatch="DENY" onMismatch="NEUTRAL"/>
+      </filters>
+      <AppenderRef ref="Async"/>
+    </Root>
+  </Loggers>
 </Configuration>
